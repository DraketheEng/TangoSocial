<section class="h-screen flex bg-base-100" style="margin-top: 6rem">
  <!-- LEFT: Conversations -->
  <div class="w-full md:w-1/3 border-r border-base-300 overflow-y-auto p-4">
    <div class="mb-3">
      <div class="relative">
        <input [(ngModel)]="searchQ" type="text" placeholder="Kullanıcı ara..." class="input input-bordered w-full pr-10" />
        <i class="fa fa-search absolute right-3 top-3 text-muted"></i>
      </div>
    </div>

    <ul class="space-y-2">
      <li *ngFor="let convo of filteredConversations()"
          class="p-3 rounded-lg cursor-pointer transition-shadow"
          [ngClass]="{
            'bg-white shadow-md': convo === selectedConversation,
            'bg-base-200': convo !== selectedConversation
          }"
          (click)="selectConversation(convo)">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full overflow-hidden border-2" [style.border-color]="'var(--ts-primary)'">
            <img [src]="convo.avatar" alt="{{convo.name}}" class="w-full h-full object-cover" />
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold truncate">{{ convo.name }}</div>
              <div class="text-xs text-muted whitespace-nowrap">
                {{ convo.messages.length ? (convo.messages[convo.messages.length - 1].time) : '' }}
              </div>
            </div>

            <div class="flex items-center gap-2 mt-1">
              <div [ngClass]="getLastMessageClass(convo)" class="text-sm truncate min-w-0">
                {{ getLastMessageDisplay(convo) }}
              </div>
              <span *ngIf="convo.unread" class="badge badge-rose badge-sm ml-auto">Yeni</span>
            </div>

            <div *ngIf="convo.typing" class="text-xs text-muted mt-1">Karşı taraf yazıyor...</div>
          </div>
        </div>
      </li>
    </ul>

    <button class="ts-btn ts-btn-ghost w-full mt-4" (click)="startNewChat()">+ Yeni Konuşma</button>
  </div>

  <!-- RIGHT: Selected Conversation -->
  <div class="w-full md:w-2/3 flex flex-col" style="height: 85%">
    <!-- Header -->
    <div class="p-4 border-b border-base-300 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full overflow-hidden border-2" [style.border-color]="'var(--ts-primary)'">
          <img [src]="selectedConversation?.avatar" alt="Avatar" class="w-full h-full object-cover" />
        </div>
        <div>
          <div class="font-semibold">{{ selectedConversation?.name }}</div>
          <div class="text-xs text-muted" *ngIf="selectedConversation?.typing">Yazıyor...</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button class="ts-btn ts-btn-ghost btn-sm" (click)="selectConversation(selectedConversation)"><i class="fa-solid fa-phone"></i></button>
        <button class="ts-btn ts-btn-ghost btn-sm" (click)="selectConversation(selectedConversation)"><i class="fa-solid fa-video"></i></button>
        <button class="ts-btn ts-btn-ghost btn-sm" (click)="selectConversation(selectedConversation)"><i class="fa-solid fa-ellipsis"></i></button>
      </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesList">
      <div *ngFor="let msg of selectedConversation?.messages">
        <div class="chat" [ngClass]="msg.sender === currentUser ? 'chat-end' : 'chat-start'">
          <div class="chat-image avatar">
            <div class="w-10 rounded-full">
              <img [src]="msg.avatar" />
            </div>
          </div>

          <div class="chat-header">
            {{ msg.sender }}
            <time class="text-xs opacity-50 ml-2">{{ msg.time }}</time>
          </div>

          <!-- image message -->
          <div *ngIf="msg.imageUrl" class="chat-bubble chat-bubble-image p-0 overflow-hidden">
            <img [src]="msg.imageUrl" class="w-full object-cover" />
          </div>

          <!-- text message -->
          <div *ngIf="msg.text" class="chat-bubble">{{ msg.text }}</div>

          <div class="chat-footer opacity-50">{{ msg.status }}</div>
        </div>
      </div>

      <!-- scroll anchor -->
      <div #messagesEnd></div>
    </div>

    <!-- Composer -->
    <form class="p-4 border-t border-base-300 flex items-end gap-3" (submit)="sendMessage(); $event.preventDefault();">
      <button type="button" class="ts-btn ts-btn-ghost" (click)="attachFileClick()">
        <i class="fa-solid fa-paperclip"></i>
      </button>
      <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden />

      <button type="button" class="ts-btn ts-btn-ghost" (click)="toggleEmojiPicker()">
        <i class="fa-solid fa-face-smile"></i>
      </button>

      <div class="flex-1 relative">
        <textarea
          [(ngModel)]="newMessage"
          name="message"
          rows="1"
          (keydown)="onKeydown($event)"
          class="input input-bordered w-full resize-none h-12 p-3"
          placeholder="Mesaj yaz... (Enter gönder, Shift+Enter yeni satır)"></textarea>

        <!-- emoji picker -->
        <div *ngIf="showEmojiPicker" class="emoji-picker p-2 shadow-md rounded bg-white">
          <div class="grid grid-cols-6 gap-2">
            <button *ngFor="let e of emojis" class="ts-btn ts-btn-ghost btn-xs p-2 text-lg" (click)="addEmoji(e)">{{ e }}</button>
          </div>
        </div>
      </div>

      <button class="ts-btn ts-btn-primary" type="submit">
        <i class="fa-solid fa-paper-plane"></i> Gönder
      </button>
    </form>
  </div>
</section>
